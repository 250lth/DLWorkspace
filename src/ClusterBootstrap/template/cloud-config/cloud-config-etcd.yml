#cloud-config
coreos:
  update:
    reboot-strategy: off
  units:
    # There should be exactly 4 spaces before the -name. 
    # This is to ensure additional option units can be added through configuration.   
    - name: update-engine.service
      command: stop
    - name: locksmithd.service
      command: stop
    - name: checkinternet.service
      command: start
      content: |
        [Unit]
        Description=Check Internet Connection and DNS
        After=network-online.target
        Requires=network-online.target
        [Service]
        Restart=always
        RestartSec=60s
        ExecStart=/bin/bash /opt/checkinternet.sh
        [Install]
        WantedBy=local.target
    - name: reportcluster.service
      command: start
      content: |
        [Unit]
        Description=Report node to cluster portal
        After=network-online.target
        Requires=network-online.target
        [Service]
        #RemainAfterExit=true
        Restart=always
        RestartSec=60s
        ExecStart=/bin/bash /opt/report.sh
        [Install]
        WantedBy=local.target
    - name: nvidia-driver.service
      command: start
      content: |
        [Unit]
        Description=Install Nvidia driver and nvidia-docker
        After=local-fs.target network.target
        Wants=docker.service
        [Service]
        Environment="SOCK_DIR=/var/lib/nvidia-docker"
        Environment="SPEC_FILE=/etc/docker/plugins/nvidia-docker.spec"
        Restart=always
        RestartSec=10
        TimeoutStartSec=1200
        TimeoutStopSec=120
        ExecStart=/opt/install_nvidia_docker.sh
        ExecStartPost=/bin/sh -c '/bin/mkdir -p $( dirname $SPEC_FILE )'
        ExecStartPost=/bin/sh -c '/bin/echo unix://$SOCK_DIR/nvidia-docker.sock > $SPEC_FILE'
        ExecStopPost=/bin/rm -f $SPEC_FILE
        [Install]
        WantedBy=multi-user.target
{{cnf["coreosunits"]}}

ssh_authorized_keys:
  {{cnf["sshKeys"]}}

write_files:
  # There should be exactly 2 spaces before the -path. 
  # This is to ensure additional option write_files entries can be added through configuration.  
  - path: "/etc/resolve.conf"
    permissions: "0755"
    owner: "core"
    content: |
      {{cnf["dnsservers"]}}

  - path: "/opt/homeinserver"
    permissions: "0755"
    owner: "core"
    content: |
      {{cnf["homeinserver"]}}
      
  - path: "/opt/homeininterval"
    permissions: "0755"
    owner: "core"
    content: |
      {{cnf["homeininterval"]}}
      
  - path: "/opt/discoverserver"
    permissions: "0755"
    owner: "core"
    content: |
      {{cnf["discoverserver"]}}

  - path: "/opt/systemrole"
    permissions: "0755"
    owner: "core"
    content: |
      etcd
  
  - path: "/opt/report.sh"
    permissions: "0755"
    owner: "root"
    encoding: "base64"
    content: |
      {{cnf["report.sh"]}}
      
  - path: "/opt/checkinternet.sh"
    permissions: "0755"
    owner: "root"
    encoding: "base64"
    content: |
      {{cnf["checkinternet.sh"]}}
      
  - path: "/opt/install_nvidia_docker.sh"
    permissions: "0755"
    owner: "root"
    encoding: "base64"
    content: |
      {{cnf["install_nvidia_docker.sh"]}}

{{cnf["coreoswritefiles"]}}