@{
    ViewData["Title"] = "Submit Your Job";
}

<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.10.2.min.js" type="text/javascript"></script>
<script>
    $(document).ready(function () {
        $('#submit_job').on('submit', function (e) { //use on if jQuery 1.7+
            e.preventDefault();  //prevent form from submitting

            var params = "";

            var jobname = $("#jobname").val().trim();
            var workpath = $("#workpath").val().trim();
            var datapath = $("#datapath").val().trim();
            var jobpath = $("#jobpath").val().trim();
            var image = $("#image").val().trim();
            var cmd = $("#cmd").val().trim();
            var logdir = $("#logdir").val().trim();
            var interactiveport = $("#interactiveport").val().trim();

            
            var numGPUsInt = parseInt($('#resourcegpu').val());
            var numGPUStr = $('#resourcegpu').val();

            if (numGPUsInt < 0 || numGPUsInt > 8) {
                alert("Invalid GPU number:" + numGPUStr + ". GPU number has to be 0 - 8 in regular job");
                return;
            }



            if (jobname == "") {
                alert("Job Name cannot be empty!");
                return;
            }
            if (workpath == "") {
                alert("Work Path cannot be empty!");
                return;
            }
            if (datapath == "") {
                alert("Data Path cannot be empty!");
                return;
            }

            if (image == "") {
                alert("Docker Image cannot be empty!");
                return;
            }

            if (cmd == "") {
                alert("Default CMD in docker image:"+image+". will be executed");
            }

            params = params + "resourcegpu=" + numGPUStr + "&";
            params = params + "jobname=" + jobname + "&";
            params = params + "workpath=" + workpath + "&";
            params = params + "datapath=" + datapath + "&";

            var jobpath = $('#jobpath').val();
            if (jobpath != "") {
                params = params + "jobpath=" + jobpath + "&";
            }

            params = params + "image=" + $('#image').val() + "&";
            params = params + "cmd=" + $('#cmd').val() + "&";

            var logdir = $('#logdir').val();
            if (logdir != "") {
                params = params + "logdir=" + jobpath + "&";
            }

            var interactiveport = $('#interactiveport').val();
            if (interactiveport != "") {
                params = params + "interactiveport=" + interactiveport + "&";
            }
            
            var username = "@User.Identity.Name".replace("REDMOND","")
            //console.log(username)
            params = params + "username=" + username;

            var url = "@ViewData["restapi"]/SubmitJob?" + params;

            //console.log(url);
            $.ajax({
                url: url,
                dataType: 'json',
                timeout: 10000 //3 second timeout, 
            }).done(
                function (payload) {
                    console.log(payload);
                    if (payload.jobId) {
                        alert("Job Submitted! \n Job ID:" + payload.jobId)
                        location.href = "/Home/ViewJobs";
                    } else if (payload.error) {
                        alert("Error: " + payload.error, "Alert");
                    } else {
                        alert("Unexpected error: " + payload, "Alert");
                    }
            });

        });
    });
</script>


<div class="modal-dialog" role="document">
    <div class="modal-content">
        <form method="POST" id="submit_job">

            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="submitModalLabel">Submit Job</h4>
            </div>

            <div class="modal-body">

                <div class="form-group">
                    <label>
                        Job Name
                    </label>
                    <input type="text" class="form-control" id="jobname" />
                </div>

                <div class="form-group">
                    <label>
                        Number of GPUs to use
                    </label>
                    <input type="number" class="form-control" id="resourcegpu" value="1"/>
                </div>

                <div class="form-group">
                    <label>
                        Work Directory
                    </label>
                    <input type="text" class="form-control" id="workpath" />
                </div>

                <div class="form-group">
                    <label>
                        Data Directory
                    </label>
                    <input type="text" class="form-control" id="datapath" />
                </div>

                <div class="form-group">
                    <label>
                        Job Directory (empty by default)
                    </label>
                    <input type="text" class="form-control" id="jobpath" />
                </div>

                <div class="form-group">
                    <label>
                        Docker Image
                    </label>
                    <input type="text" class="form-control" id="image" />
                </div>

                <div class="form-group">
                    <label>
                        Training Command
                    </label>
                    <input type="text" class="form-control" id="cmd" />
                </div>

                <div class="form-group">
                    <label>
                        To enable TensorBoard, type model path here
                    </label>
                    <input type="text" class="form-control" id="logdir" />
                </div>

                <div class="form-group">
                    <label>
                        To enable interactive job, type port number here
                    </label>
                    <input type="text" class="form-control" id="interactiveport" />
                </div>

            </div>
            <div class="modal-footer">
                <input type="submit" value="Submit" name="submit" class="btn btn-success" id="submit" />
            </div>
        </form>
    </div>
</div>
